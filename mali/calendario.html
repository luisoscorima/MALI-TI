<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calendario MALI Educación</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
  <style>
    /* Estilos generales del contenedor del calendario */
    #calendar-section {
      width: 100%;
      max-width: 900px;
      margin: auto;
      font-family: 'Poppins', sans-serif;
    }
    h2 {
      text-align: center;
    }
    
    /* Contenedor principal del calendario con grid para los días */
    #calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 10px;
      padding: 10px;
    }
    
    /* Encabezado de los días de la semana */
    .day-header {
      font-weight: bold;
      text-align: center;
      padding: 10px;
    }
    
    /* Estilo de cada día en el calendario */
    .day {
      border: 1px solid #f3f3f3;
      height: 120px;
      position: relative;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: flex-start;
      box-sizing: border-box;
      overflow: hidden;
      background: #f3f3f3;
    }
    
    /* Número del día en la esquina superior derecha */
    .day-number {
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 18px;
      font-weight: normal;
      color: black;
    }
    .day.has-event .day-number {
      color: white;
    }
    
    /* Contenedor para los eventos del día */
    .event-container {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    /* Estilos de cada evento */
    .event {
      flex-grow: 1;
      font-size: 12px;
      color: #fff;
      text-align: center;
      box-sizing: border-box;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 5px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    /* Tooltip estilo globo de texto */
    .event-tooltip {
      display: none;
      position: absolute;
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 15px;
      box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      width: 300px;
      max-height: 250px;
      overflow-y: auto;
    }
    .tooltip-header {
      display: flex;
      justify-content: right;
      align-items: right;
    }
    .tooltip-header button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
    }
    .tooltip-title {
      font-size: 18px;
      font-weight: bold;
      margin: 10px 0;
    }

    /* Estilo general para la barra de desplazamiento del tooltip */
    .event-tooltip::-webkit-scrollbar {
      width: 6px; /* Ancho de la barra de desplazamiento */
    }

    .event-tooltip::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.1); /* Color del pulgar de la barra de desplazamiento */
      border-radius: 10px;
    }

    .event-tooltip::-webkit-scrollbar-track {
      background-color: transparent; /* Fondo de la pista de desplazamiento */
    }

    /* Para Firefox */
    .event-tooltip {
      scrollbar-width: thin; /* Barra de desplazamiento más delgada */
      scrollbar-color: rgba(0, 0, 0, 0.1) transparent; /* Color del pulgar y la pista */
    }

    /* Ajustar el tamaño y la apariencia del tooltip */
    .event-tooltip {
      max-height: 250px;
      overflow-y: auto;
    }


      /* Estilo general para los botones y selectores */
    button, select {
      font-size: 14px;
      padding: 8px 12px;
      background-color: transparent;
      border: 1px solid transparent;  /* No tiene borde por defecto */
      color: #333;
      cursor: pointer;
      border-radius: 5px;
      transition: all 0.3s ease;
    }

    /* Estilo para los botones con borde */
    #btn-today {
      background-color: #CF85E2;
      color: white;
      border: 2px solid #CF85E2;  /* Borde azul para el botón Hoy */
      font-weight: bold;
    }

    /* Estilo para los botones de cambio de mes y año (sin borde) */
    button:not(#btn-today) {
      background-color: transparent;
      color: #CF85E2;
      border: none;
    }

    /* Estilo de los botones al pasar el ratón (hover) */
    button:hover {
      background-color: #f8f9fa;
      border-color: #007bff;
    }

    /* Estilo para el selector de mes y año */
    select {
      background-color: transparent;
      border: 1px solid #e4e4e4; /* Un borde suave */
    }

    /* Estilo al seleccionar un mes/año */
    select:focus {
      border-color: #007bff;  /* Borde azul cuando se selecciona */
      box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
    }
  </style>
</head>
<body>
  <section id="calendar-section">
    <div id="calendar-container">
      <button id="btn-today" onclick="goToToday()">Hoy</button>
      <button onclick="changeMonth(-1)"><i class="fas fa-arrow-left"></i></button>
      <button onclick="changeMonth(1)"><i class="fas fa-arrow-right"></i></button>
      <select id="select-month"></select>
      <select id="select-year"></select>
      <button onclick="goToSelectedMonth()">Ir</button>
      <h2 id="month-year"></h2>
    </div>
    <div id="calendar"></div>

    <div id="tooltip" class="event-tooltip">
      <div class="tooltip-header">
        <button onclick="shareEvent()" title="Copiar enlace">
            <i class="fas fa-share"></i>
        </button>
          
        <button onclick="addToCalendar()" title="Añadir al calendario">
            <i class="fas fa-bell"></i>
        </button>
          
        <button onclick="closeTooltip()" title="Cerrar">
            <i class="fas fa-times"></i>
        </button>
      </div>
      <span id="tooltip-title" class="tooltip-title"></span>
      <p id="tooltip-datetime"></p>
      <p id="tooltip-description"></p>
    </div>
  </section>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      // Variables y elementos del DOM
      const apiKey = "AIzaSyBYX8PghzeYplVqrSDUmNfrYm6jNmz4W4c";
      const calendarId = "gustavo.oscorima@gmail.com";
      const calendarDiv = document.getElementById("calendar");
      const tooltip = document.getElementById("tooltip");
      const tooltipTitle = document.getElementById("tooltip-title");
      const tooltipDatetime = document.getElementById("tooltip-datetime");
      const tooltipDescription = document.getElementById("tooltip-description");
      const monthYearLabel = document.getElementById("month-year");
      const selectMonth = document.getElementById("select-month");
      const selectYear = document.getElementById("select-year");
      const today = new Date();
      let currentYear = today.getFullYear();
      let currentMonth = today.getMonth() + 1;
  
      // Días de la semana
      const weekDays = ["Domingo", "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado"];
      
      // Nombres de los meses
      const monthNames = [
        "Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio",
        "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"
      ];
  
      // Mostrar mes y año inicial
      monthYearLabel.textContent = `${monthNames[currentMonth - 1]} ${currentYear}`;
  
      // Consultar los eventos para el mes actual
      loadEventsAndRender(currentMonth, currentYear);
  
      // Función para obtener eventos de Google Calendar
      function loadEventsAndRender(month, year) {
        const firstDayOfMonth = new Date(year, month - 1, 1).toISOString();
        const lastDayOfMonth = new Date(year, month, 0, 23, 59, 59).toISOString();
        fetch(`https://www.googleapis.com/calendar/v3/calendars/${calendarId}/events?key=${apiKey}&timeMin=${firstDayOfMonth}&timeMax=${lastDayOfMonth}&singleEvents=true&orderBy=startTime`)
          .then(response => response.json())
          .then(data => {
            if (!data.items) return;
            renderCalendar(month, year, data.items);
          })
          .catch(error => console.error("Error al cargar eventos:", error));
      }
  
      // Renderiza el calendario y asigna eventos a cada día
      function renderCalendar(month, year, events) {
        calendarDiv.innerHTML = "";
  
        // Agregar encabezados de días de la semana
        weekDays.forEach(day => {
          let dayHeader = document.createElement("div");
          dayHeader.classList.add("day-header");
          dayHeader.textContent = day;
          calendarDiv.appendChild(dayHeader);
        });
  
        const firstDay = new Date(year, month - 1, 1).getDay();
        const lastDate = new Date(year, month, 0).getDate();
  
        // Espacios vacíos antes del primer día
        for (let i = 0; i < firstDay; i++) {
          let emptyCell = document.createElement("div");
          emptyCell.classList.add("day");
          calendarDiv.appendChild(emptyCell);
        }
  
        // Creación de cada día
        for (let day = 1; day <= lastDate; day++) {
          let dayCell = document.createElement("div");
          dayCell.classList.add("day");
  
          let dayNumber = document.createElement("div");
          dayNumber.classList.add("day-number");
          dayNumber.textContent = day;
          dayCell.appendChild(dayNumber);
  
          let dayEvents = events.filter(event => {
            let eventDate;
            if (event.start.dateTime) {
              eventDate = new Date(event.start.dateTime);
            } else {
              const [yearStr, monthStr, dayStr] = event.start.date.split("-");
              eventDate = new Date(parseInt(yearStr), parseInt(monthStr) - 1, parseInt(dayStr));
            }
            return eventDate.getDate() === day &&
                  eventDate.getMonth() + 1 === month &&
                  eventDate.getFullYear() === year;
          });
  
          if (dayEvents.length > 0) {
            dayCell.classList.add("has-event");
            let eventContainer = document.createElement("div");
            eventContainer.classList.add("event-container");
  
            dayEvents.forEach(event => {
              const eventDateUTC = event.start.dateTime || event.start.date;
              const date = new Date(eventDateUTC);
              let eventEl = document.createElement("div");
              eventEl.classList.add("event");
              eventEl.dataset.title = event.summary;
              eventEl.dataset.datetime = event.start.dateTime || event.start.date;
              eventEl.dataset.description = event.description || "Sin descripción";
              eventEl.style.backgroundColor = getEventColor(eventEl.dataset.description);
              eventEl.textContent = event.summary;
              eventEl.addEventListener("click", function (e) {
                openTooltip(e, eventEl);
              });
              eventContainer.appendChild(eventEl);
              eventEl.title = event.summary;
            });
            dayCell.appendChild(eventContainer);
          }
          calendarDiv.appendChild(dayCell);
        }
      }
  
      // Función para obtener el color del evento según la descripción
      function getEventColor(description) {
        const colorMapping = {
          "Cursos de Arte": "#F2357B",
          "Extensión Profesional": "#025E73",
          "Visitas": "#F2B544",
          "Noche MALI": "#52CBD9"
        };
        const defaultColor = "#cccccc";
        if (!description) return defaultColor;
        for (let key in colorMapping) {
          if (description.includes(key)) {
            return colorMapping[key];
          }
        }
        return defaultColor;
      }
  
      // Cambia el mes
      function changeMonth(offset) {
        currentMonth += offset;
        if (currentMonth < 1) {
          currentMonth = 12;
          currentYear--;
        } else if (currentMonth > 12) {
          currentMonth = 1;
          currentYear++;
        }
        monthYearLabel.textContent = `${monthNames[currentMonth - 1]} ${currentYear}`;
        loadEventsAndRender(currentMonth, currentYear);
      }
  
      // Cambia al mes actual
      function goToToday() {
        const today = new Date();
        currentMonth = today.getMonth() + 1;
        currentYear = today.getFullYear();
        monthYearLabel.textContent = `${monthNames[currentMonth - 1]} ${currentYear}`;
        loadEventsAndRender(currentMonth, currentYear);
      }

            // Ir al mes y año seleccionados
      function goToSelectedMonth() {
        const selectedMonth = parseInt(selectMonth.value);
        const selectedYear = parseInt(selectYear.value);
        if (selectedMonth && selectedYear) {
          currentMonth = selectedMonth;
          currentYear = selectedYear;
          monthYearLabel.textContent = `${monthNames[currentMonth - 1]} ${currentYear}`;
          loadEventsAndRender(currentMonth, currentYear);
        }
      }
  
      function populateMonthYearSelectors() {
        // Añadir meses al selector de mes
        for (let i = 0; i < monthNames.length; i++) {
          const option = document.createElement("option");
          option.value = i + 1;
          option.textContent = monthNames[i];
          selectMonth.appendChild(option);
        }
        
        // Añadir años al selector de año (por ejemplo, de 2020 a 2030)
        for (let i = 2020; i <= 2030; i++) {
          const option = document.createElement("option");
          option.value = i;
          option.textContent = i;
          selectYear.appendChild(option);
        }

        // Seleccionar el mes y año actuales
        selectMonth.value = currentMonth;
        selectYear.value = currentYear;
      }

      // Muestra el tooltip
      function openTooltip(event, element) {
        const eventColor = getEventColor(element.dataset.description);
        tooltipTitle.innerHTML = `<span style="color: ${eventColor};">⬤</span> ${element.dataset.title}`;
        tooltipDatetime.textContent = new Date(element.dataset.datetime).toLocaleString();
        tooltipDatetime.style.fontSize = "12px";
        tooltipDescription.innerHTML = `<span style="color: ${eventColor};">፨</span> ${element.dataset.description}`;
        tooltipDescription.style.fontSize = "14px";
        tooltip.style.display = "block";
        tooltip.style.top = (event.clientY+10) + "px";
        tooltip.style.left = (event.clientX + 10) + "px";
        tooltip.style.padding = "30px";

        // Añadir un evento para cerrar el tooltip cuando se haga clic fuera de él
        document.addEventListener("click", closeTooltipIfClickedOutside);
      }
  
      // Cierra el tooltip
      function closeTooltip() {
        tooltip.style.display = "none";
        document.removeEventListener("click", closeTooltipIfClickedOutside);
      }
      // Función para cerrar el tooltip si el clic es fuera de él
      function closeTooltipIfClickedOutside(e) {
        if (!tooltip.contains(e.target) && !e.target.closest('.event')) {
          closeTooltip();
        }
      }
  
      // Copiar el enlace al portapapeles
      function shareEvent() {
        const url = window.location.href;
        navigator.clipboard.writeText(url)
          .then(() => alert("Enlace copiado al portapapeles"))
          .catch(err => console.error("Error al copiar:", err));
      }
  
      // Añadir evento al calendario
      function addToCalendar() {
        let title = tooltipTitle.textContent.replace(/●\s*/, "");
        let datetime = tooltipDatetime.textContent;
        let description = tooltipDescription.textContent;
        let startDate = new Date(datetime);
        let endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
  
        function formatDate(date) {
          return date.toISOString().replace(/[-:.]/g, "").split("Z")[0] + "Z";
        }
        const startStr = formatDate(startDate);
        const endStr = formatDate(endDate);
  
        const googleCalendarUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${startStr}/${endStr}&details=${encodeURIComponent(description)}`;
        window.open(googleCalendarUrl, "_blank");
      }
  
      // Hacer las funciones accesibles desde los onclick de los botones del tooltip
      window.closeTooltip = closeTooltip;
      window.shareEvent = shareEvent;
      window.addToCalendar = addToCalendar;
      window.changeMonth = changeMonth;
      window.goToToday = goToToday;
      window.goToSelectedMonth = goToSelectedMonth;
      populateMonthYearSelectors();
    });
  </script>
  

</body>
</html>
